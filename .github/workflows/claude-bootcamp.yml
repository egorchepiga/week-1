name: Claude Bootcamp Execution

# ‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ—Ç workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –í–†–£–ß–ù–£–Æ!
# - –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö master
# - –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ Claude Desktop
# - –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ GitHub Actions UI ‚Üí "Run workflow"

on:
  workflow_dispatch:
    inputs:
      lesson_start:
        description: 'Start from lesson (1-4)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      lesson_end:
        description: 'End at lesson (1-4)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      run_id:
        description: 'Run identifier (optional, e.g., experiment-1)'
        required: false
        default: ''
      custom_prompt:
        description: 'Additional prompt to append (optional)'
        required: false
        default: ''
        type: string

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

# –ü—Ä–∞–≤–∞ –¥–ª—è push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
permissions:
  contents: write

jobs:
  execute-bootcamp:
    runs-on: self-hosted
    timeout-minutes: 120

    steps:
      - name: Generate branch name
        id: branch
        run: |
          # –§–æ—Ä–º–∞—Ç: claude/master-manual_YYYYMMDD-HHMMSS –∏–ª–∏ claude/master-manual_custom-id
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RUN_ID="${{ github.event.inputs.run_id }}"
          if [ -n "$RUN_ID" ]; then
            BRANCH_NAME="claude/master-manual_${RUN_ID}"
          else
            BRANCH_NAME="claude/master-manual_${TIMESTAMP}"
          fi
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Branch: ${BRANCH_NAME}"

      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "Claude Bootcamp Bot"
          git config user.email "bot@bootcamp.local"
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ remote —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è push
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Create working branch
        run: |
          git checkout -b ${{ steps.branch.outputs.name }}
          git push -u origin ${{ steps.branch.outputs.name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      - name: Execute Claude Code
        id: claude
        run: |
          LESSON_START=${{ github.event.inputs.lesson_start }}
          LESSON_END=${{ github.event.inputs.lesson_end }}

          # Build prompt
          PROMPT=$(cat << 'PROMPT_END'
          # –ó–ê–î–ê–ß–ê: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Captain Builders Bootcamp

          ## –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–ù–¢–ï–ö–°–¢–ê

          ### –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
          –ü—Ä–æ—á–∏—Ç–∞–π —Ñ–∞–π–ª—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

          1. `CLAUDE.md` ‚Äî –∫–æ—Ä–Ω–µ–≤–æ–π entry point, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
          2. `PROGRESS.md` ‚Äî —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          3. `shared/CLAUDE.md` ‚Äî –æ–±—â–∏–µ —Ñ–æ—Ä–º—É–ª—ã –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏

          ### –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫—É—Ä—Å–∞
          4. `inputs/CLAUDE.md` ‚Äî –æ–±–∑–æ—Ä –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          5. `inputs/course/CLAUDE.md` ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–æ–≤ –∫—É—Ä—Å–∞
          6. `inputs/bootcamp-recordings/ERRORS_CATALOG.md` ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –∫–∞—Ç–∞–ª–æ–≥ —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
          7. `inputs/bootcamp-recordings/SUMMARY.md` ‚Äî –≤—ã–∂–∏–º–∫–∞ –∏–∑ —Ä–∞–∑–±–æ—Ä–æ–≤

          ### –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤
          8. `lesson-01/CLAUDE.md` ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —É—Ä–æ–∫–∞ 1
          9. `lesson-02/CLAUDE.md` ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —É—Ä–æ–∫–∞ 2
          10. `lesson-02/keywords/CLAUDE.md` ‚Äî –≥–∞–π–¥ –ø–æ Semrush –¥–ª—è AI

          ## –í–´–ü–û–õ–ù–ï–ù–ò–ï

          –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏ —É—Ä–æ–∫–∏ –æ—Ç LESSON_START –¥–æ LESSON_END –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ.

          ### –£—Ä–æ–∫ 1: –í—ã–±–æ—Ä –∏–¥–µ–∏
          - –ü—Ä–æ—á–∏—Ç–∞–π `inputs/course/parsed/01_vybor_idei.md`, `02_ocenka_dohodnosti.md`, `03_podschet_ballov.md`
          - –ò—Å–ø–æ–ª—å–∑—É–π `inputs/app-database/*.xlsx` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞
          - –ü—Ä–æ–≤–µ—Ä—å –∏–¥–µ–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –∏–∑ `ERRORS_CATALOG.md`
          - –°–æ–∑–¥–∞–π –æ—Ç—á—ë—Ç—ã –≤ `lesson-01/outputs/`
          - –í—ã–±–µ—Ä–∏ –¢–û–ü-3 –∏–¥–µ–∏ –¥–ª—è —É—Ä–æ–∫–∞ 2

          ### –£—Ä–æ–∫ 2: Keyword Research
          - –ü—Ä–æ—á–∏—Ç–∞–π `inputs/course/parsed/04-09_*.md`
          - –ò—Å–ø–æ–ª—å–∑—É–π Semrush (MCP Playwright) –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
          - –°–ª–µ–¥—É–π –∞–ª–≥–æ—Ä–∏—Ç–º—É –∏–∑ `lesson-02/keywords/CLAUDE.md`
          - –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ `inputs/app-database/*.xlsx`
          - –ü—Ä–æ–≤–µ—Ä—å —Å–æ—Ñ—Ç–æ–≤–æ—Å—Ç—å –≤ Google SERP
          - –°–æ–∑–¥–∞–π –æ—Ç—á—ë—Ç—ã –ø–æ —à–∞–±–ª–æ–Ω–∞–º –∏–∑ `lesson-02/templates/`
          - –°–æ–∑–¥–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç `lesson-02/outputs/KEYWORD_RESEARCH_REPORT.md`

          ## –ü–†–ê–í–ò–õ–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø

          1. **–û–±–Ω–æ–≤–ª—è–π PROGRESS.md** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–∏–º–æ–≥–æ —à–∞–≥–∞
          2. **–ü—Ä–æ–≤–µ—Ä—è–π –∏–¥–µ–∏ –Ω–∞ –æ—à–∏–±–∫–∏** –∏–∑ ERRORS_CATALOG.md –ø–µ—Ä–µ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
          3. **–°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ –æ—Ç—á—ë—Ç—ã** –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ outputs/ –ø–∞–ø–∫–∏
          4. **–ò—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω—ã** –∏–∑ templates/ –ø–∞–ø–æ–∫
          5. **–ö–æ–º–º–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ —ç—Ç–∞–ø–∞

          ## –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

          - [ ] –í—Å–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
          - [ ] –£—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
          - [ ] –û—Ç—á—ë—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö
          - [ ] PROGRESS.md –æ–±–Ω–æ–≤–ª—ë–Ω
          - [ ] –ò–¥–µ–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
          - [ ] –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –æ–±–æ—Å–Ω–æ–≤–∞–Ω

          ## –§–û–†–ú–ê–¢ –ö–û–ú–ú–ò–¢–û–í

          ```
          feat(lesson-XX): –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

          - –î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          - –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

          ü§ñ Generated with Claude Code
          Co-Authored-By: Claude <noreply@anthropic.com>
          ```

          –ù–∞—á–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–π—á–∞—Å.
          PROMPT_END
          )

          # Replace placeholders
          PROMPT="${PROMPT//LESSON_START/$LESSON_START}"
          PROMPT="${PROMPT//LESSON_END/$LESSON_END}"

          # Append custom prompt if provided
          CUSTOM_PROMPT="${{ github.event.inputs.custom_prompt }}"
          if [ -n "$CUSTOM_PROMPT" ]; then
            PROMPT="${PROMPT}

          ## –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò

          ${CUSTOM_PROMPT}"
            echo "Custom prompt added"
          fi

          echo "Starting Claude Code execution..."
          echo "Lessons: $LESSON_START to $LESSON_END"

          # Execute Claude Code with live streaming
          # --verbose –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
          # stdbuf -oL –¥–ª—è line-buffered output
          stdbuf -oL claude --dangerously-skip-permissions --verbose -p "$PROMPT" 2>&1 | tee claude_output.log

          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT

      - name: Commit generated files
        if: always()
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$(cat << 'EOF'
          feat(bootcamp): Auto-generated files from Claude execution

          Lessons: ${{ github.event.inputs.lesson_start }} to ${{ github.event.inputs.lesson_end }}
          Branch: ${{ steps.branch.outputs.name }}
          Run ID: ${{ github.run_id }}

          ü§ñ Generated with Claude Code
          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"
            git push
          fi

      - name: Upload execution log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-execution-log
          path: claude_output.log
          retention-days: 30

      - name: Create summary
        if: always()
        run: |
          echo "## Bootcamp Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ steps.branch.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Lessons:** ${{ github.event.inputs.lesson_start }} to ${{ github.event.inputs.lesson_end }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Exit Code:** ${{ steps.claude.outputs.exit_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 2>/dev/null || echo "No previous commit to compare"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Check execution status
        if: steps.claude.outputs.exit_code != '0'
        run: |
          echo "::warning::Claude Code exited with code ${{ steps.claude.outputs.exit_code }}"
          echo "Check the execution log for details"

      - name: Cleanup branch on failure
        if: failure() || steps.claude.outputs.exit_code != '0'
        run: |
          echo "Job failed, deleting branch: ${{ steps.branch.outputs.name }}"
          git push origin --delete ${{ steps.branch.outputs.name }} || echo "Branch already deleted or not found"
